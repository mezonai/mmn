name: Deploy Node Sync (Listener)

on:
  workflow_dispatch:
    inputs:
      tag_to_deploy:
        description: "Tag of the release to deploy (e.g., v0.1.0)"
        required: true

  workflow_call:
    inputs:
      tag_to_deploy:
        description: "Tag of the release to deploy"
        required: true
        type: string
      binary_path_from_caller:
        description: "Path to binary file if already present on the runner"
        required: false
        type: string
    secrets:
      LISTENER_PRIVKEY:
        required: true
      VERIFYING_KEY_B64:
        required: true

jobs:
  deploy_listener:
    runs-on: [self-hosted, Linux, mezon-runner]
    environment: prod
    steps:
      - name: Checkout code to access config templates
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag_to_deploy }}

      - name: Download release binary
        if: github.event_name == 'workflow_dispatch'
        id: download_step
        run: |
          set -e
          BINARY_NAME="mmn-${{ inputs.tag_to_deploy }}"
          BINARY_PATH="build/${BINARY_NAME}"
          OWNER=$(echo "$GITHUB_REPOSITORY" | cut -d/ -f1)
          REPO=$(echo "$GITHUB_REPOSITORY" | cut -d/ -f2)
          DOWNLOAD_URL="https://github.com/$OWNER/$REPO/releases/download/${{ inputs.tag_to_deploy }}/${BINARY_NAME}"

          echo "==> Downloading from URL: $DOWNLOAD_URL"
          mkdir -p build
          curl -sSL --fail -o "$BINARY_PATH" "$DOWNLOAD_URL"
          echo "==> Download complete: $BINARY_PATH"
          ls -lh "$BINARY_PATH"
          echo "binary_path=$BINARY_PATH" >> $GITHUB_OUTPUT

      - name: Setup Listener Service
        env:
          LISTENER_PRIVKEY: ${{ secrets.LISTENER_PRIVKEY }}
          BOOTNODE_IP_LISTENER: ${{ vars.BOOTNODE_IP_LISTENER }}
          BOOTNODE_ID: ${{ vars.BOOTNODE_ID }}
          PUBLIC_IP_LISTENER: ${{ vars.PUBLIC_IP_LISTENER }}
          VERIFYING_KEY_B64: ${{ secrets.VERIFYING_KEY_B64 }}
        run: |
          set -e
          echo "==> Setting up mezon-listener service locally for prod env..."
          echo "--> Preparing directories..."
          sudo mkdir -p /etc/mezon /opt/mezon/mmn/bin /opt/mezon/node-data
          sudo chown -R mmn:mmn /etc/mezon
          sudo chown -R mmn:mmn /opt/mezon

          echo "--> Writing listener private key..."
          printf '%s' "$LISTENER_PRIVKEY" | sudo tee /etc/mezon/listener_privkey.txt >/dev/null
          sudo chmod 600 /etc/mezon/listener_privkey.txt
          sudo chown mmn:mmn /etc/mezon/listener_privkey.txt

          echo "--> Writing verifying key..."
          printf '%s' "$VERIFYING_KEY_B64" | sudo tee /opt/mezon/mmn/config/verifying_key.b64 >/dev/null
          sudo chmod 600 /opt/mezon/mmn/config/verifying_key.b64
          sudo chown mmn:mmn /opt/mezon/mmn/config/verifying_key.b64

          echo "--> Creating listener systemd service file..."
          BOOTNODE_MULTIADDR="/ip4/$BOOTNODE_IP_LISTENER/tcp/9000/p2p/$BOOTNODE_ID"
          sed -e "s|__BOOTNODE_MULTIADDR__|$BOOTNODE_MULTIADDR|g" \
            -e "s|__PUBLIC_IP__|$PUBLIC_IP_LISTENER|g" \
            -e "s|p2p-port 9001|p2p-port 9094|g" \
            /opt/mezon/mmn/config/systemd/mezon-listener.service.tpl \
            | sudo tee /etc/systemd/system/mezon-listener.service >/dev/null

          echo "--> Creating listener env file..."
          sudo tee /etc/mezon/node-listener.env >/dev/null <<EOL
          LOGFILE=node-listener.log
          LOGLEVEL=warn
          LOGFILE_MAX_SIZE_MB=500
          LOGFILE_MAX_AGE_DAYS=3
          CORS_ALLOWED_ORIGINS=*
          CORS_ALLOWED_METHODS=POST,OPTIONS
          CORS_ALLOWED_HEADERS=Content-Type
          EOL
          sudo chmod 644 /etc/mezon/node-listener.env
          sudo chown mmn:mmn /etc/mezon/node-listener.env

          sudo systemctl daemon-reload
          sudo systemctl enable mezon-listener

      - name: Deploy and Restart Listener
        env:
          NODE1_ADDRESS: ${{ vars.NODE1_ADDRESS }}
          FAUCET_ADDRESS: ${{ vars.FAUCET_ADDRESS }}
        run: |
          set -e
          BINARY_TO_INSTALL="${{ inputs.binary_path_from_caller || steps.download_step.outputs.binary_path }}"
          
          if [ -z "$BINARY_TO_INSTALL" ]; then
            echo "::error::Binary path is not available. Aborting."
            exit 1
          fi
          echo "==> Using binary file at: $BINARY_TO_INSTALL"

          echo "==> Deploying and restarting mezon-listener..."
          SHA=$(date +%s)
          
          sudo systemctl stop mezon-listener || true

          sudo install -m 0755 "$BINARY_TO_INSTALL" /opt/mezon/mmn/bin/mmn-${SHA}
          sudo ln -sfn mmn-${SHA} /opt/mezon/mmn/bin/mmn
          
          if [ ! -f "/etc/mezon/genesis.yml" ]; then
            echo "--> Generating genesis.yml locally for listener..."
            sed \
              -e "s|__LEADER_ADDRESS__|$NODE1_ADDRESS|g" \
              -e "s|__FAUCET_ADDRESS__|$FAUCET_ADDRESS|g" \
              ./config/genesis.template.yml \
              | sudo tee /etc/mezon/genesis.yml >/dev/null
            sudo chown mmn:mmn /etc/mezon/genesis.yml
          fi
          if [ ! -d "/opt/mezon/node-data/node-listener" ]; then
            echo "--> Initializing node data directory..."
            set -a
            source /etc/mezon/node-listener.env
            set +a
            sudo -u mmn -E /opt/mezon/mmn/bin/mmn init \
                --data-dir "/opt/mezon/node-data/node-listener" \
                --genesis "/etc/mezon/genesis.yml" \
                --database rocksdb \
                --privkey-path "/etc/mezon/listener_privkey.txt"
            fi
          sudo systemctl start mezon-listener || true

      - name: Healthcheck Listener
        run: |
          echo "==> Healthchecking local listener..."
          sleep 5
          sudo systemctl --no-pager -l status mezon-listener | tail -n 50
          curl -sSf http://127.0.0.1:8084/health || true