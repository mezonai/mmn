syntax = "proto3";
package mmn;

option go_package = "mmn/proto;proto";

// Transaction status enum
enum TransactionStatus {
  PENDING = 0;      // Transaction is in mempool
  CONFIRMED = 1;    // Transaction is included in a block
  FINALIZED = 2;    // Transaction is finalized (block has enough votes)
  FAILED = 3;       // Transaction failed validation
}

// Transaction data structure for transactions
message TransactionData {
  string tx_hash = 1;
  string sender = 2; // sender address
  string recipient = 3; // recipient address
  string amount = 4; // amount
  uint64 nonce = 5; // nonce
  uint64 timestamp = 6;
  TransactionStatus status = 7;
  string text_data = 8;
  string extra_info = 9;
}

message TxMsg { 
  int32 type = 1;
  string sender = 2;
  string recipient = 3;
  string amount = 4;
  uint64 timestamp = 5;
  string text_data = 6;
  uint64 nonce = 7;
  string extra_info = 8;
  string zk_proof = 9;
  string zk_pub = 10;
}

message SignedTxMsg {
  TxMsg tx_msg = 1;
  string signature = 2;
}

message AddTxResponse {
  bool   ok      = 1;
  string tx_hash = 2;
  string error   = 3;
}

message GetTxByHashRequest {
  string tx_hash = 1;
}

message TxInfo {
  string sender = 1;
  string recipient = 2;
  string amount = 3;
  uint64 timestamp = 4;
  string text_data = 5;
  uint64 nonce = 6;
  uint64 slot = 7;
  string blockhash = 8;
  int32 status = 9;
  string err_msg = 10;
  string extra_info = 11;
}

message GetTxByHashResponse {
  string error = 1;
  TxInfo tx = 2;
  uint32 decimals = 3; // Number of fractional digits for amount formatting
}

// Request to get transaction status
message GetTransactionStatusRequest {
  string tx_hash = 1;
}

// Unified transaction status message used for both unary and streaming responses
// TODO: consider to have single field as wrapper for all original transaction attributes (amount, text data, extra...) to avoid code duplication
message TransactionStatusInfo {
  string tx_hash = 1;
  TransactionStatus status = 2;
  uint64 block_slot = 3;        // Slot where transaction was included (if confirmed/finalized)
  string block_hash = 4;        // Hash of the block (if confirmed/finalized)
  uint64 confirmations = 5;     // Number of confirmations
  string error_message = 6;     // Error message if failed
  uint64 timestamp = 7;         // Timestamp when status was last updated
  string extra_info = 8;        // Extra info that was attached to transaction on creation
  string amount = 9;            // Transaction amount
  string text_data = 10;        // Transaction text data
}

// Request to subscribe to all transaction status updates
message SubscribeTransactionStatusRequest {
  // Empty request - subscribes to all transaction events
}

// Request to get all pending transactions
message GetPendingTransactionsRequest {}

// Response containing pending transactions information
message GetPendingTransactionsResponse {
  uint64 total_count = 1;                
  repeated TransactionData pending_txs = 2; 
  string error = 3;      
}

service TxService {
  rpc AddTx (SignedTxMsg) returns (AddTxResponse);
  rpc GetTxByHash (GetTxByHashRequest) returns (GetTxByHashResponse);
  
  // Get current status of a transaction
  rpc GetTransactionStatus(GetTransactionStatusRequest) returns (TransactionStatusInfo);
  
  // Subscribe to status updates for all transactions
  rpc SubscribeTransactionStatus(SubscribeTransactionStatusRequest) returns (stream TransactionStatusInfo);
  
  // Get all pending transactions from mempool
  rpc GetPendingTransactions(GetPendingTransactionsRequest) returns (GetPendingTransactionsResponse);

  // Multisig Faucet RPCs
  rpc CreateFaucetRequest(CreateFaucetRequestRequest) returns (CreateFaucetRequestResponse);
  rpc AddSignature(AddSignatureRequest) returns (AddSignatureResponse);
  rpc RejectProposal(RejectProposalRequest) returns (RejectProposalResponse);
  rpc GetMultisigTransactionStatus(GetMultisigTransactionStatusRequest) returns (GetMultisigTransactionStatusResponse);
  rpc AddToApproverWhitelist(AddToApproverWhitelistRequest) returns (AddToApproverWhitelistResponse);
  rpc AddToProposerWhitelist(AddToProposerWhitelistRequest) returns (AddToProposerWhitelistResponse);
  rpc RemoveFromApproverWhitelist(RemoveFromApproverWhitelistRequest) returns (RemoveFromApproverWhitelistResponse);
  rpc RemoveFromProposerWhitelist(RemoveFromProposerWhitelistRequest) returns (RemoveFromProposerWhitelistResponse);
  rpc CheckWhitelistStatus(CheckWhitelistStatusRequest) returns (CheckWhitelistStatusResponse);
  rpc GetApproverWhitelist(GetApproverWhitelistRequest) returns (GetApproverWhitelistResponse);
  rpc GetProposerWhitelist(GetProposerWhitelistRequest) returns (GetProposerWhitelistResponse);
}

// Multisig Faucet Messages
message CreateFaucetRequestRequest {
  string multisig_address = 1;
  string recipient = 2;
  string amount = 3;
  string text_data = 4;
  string signer_pubkey = 5;
  string signature = 6;
  string zk_proof = 7;
  string zk_pub = 8;
}

message CreateFaucetRequestResponse {
  bool success = 1;
  string message = 2;
  string tx_hash = 3;
}

message AddSignatureRequest {
  string tx_hash = 1;
  string signer_pubkey = 2;
  string signature = 3;
  string zk_proof = 4;
  string zk_pub = 5;
}

message AddSignatureResponse {
  bool success = 1;
  string message = 2;
  int32 signature_count = 3;
}

message RejectProposalRequest {
  string tx_hash = 1;
  string signer_pubkey = 2;
  string signature = 3;
  string zk_proof = 4;
  string zk_pub = 5;
}

message RejectProposalResponse {
  bool success = 1;
  string message = 2;
}

message GetMultisigTransactionStatusRequest {
  string tx_hash = 1;
}

message GetMultisigTransactionStatusResponse {
  bool success = 1;
  string message = 2;
  string status = 3;
  int32 signature_count = 4;
  int32 required_signatures = 5;
}

message AddToApproverWhitelistRequest {
  string address = 1;
  string signer_pubkey = 2;
  string signature = 3;
  string zk_proof = 4;
  string zk_pub = 5;
}

message AddToApproverWhitelistResponse {
  bool success = 1;
  string message = 2;
}

message AddToProposerWhitelistRequest {
  string address = 1;
  string signer_pubkey = 2;
  string signature = 3;
  string zk_proof = 4;
  string zk_pub = 5;
}

message AddToProposerWhitelistResponse {
  bool success = 1;
  string message = 2;
}

message RemoveFromApproverWhitelistRequest {
  string address = 1;
  string signer_pubkey = 2;
  string signature = 3;
  string zk_proof = 4;
  string zk_pub = 5;
}

message RemoveFromApproverWhitelistResponse {
  bool success = 1;
  string message = 2;
}

message RemoveFromProposerWhitelistRequest {
  string address = 1;
  string signer_pubkey = 2;
  string signature = 3;
  string zk_proof = 4;
  string zk_pub = 5;
}

message RemoveFromProposerWhitelistResponse {
  bool success = 1;
  string message = 2;
}

message CheckWhitelistStatusRequest {
  string address = 1;
}

message CheckWhitelistStatusResponse {
  bool success = 1;
  string message = 2;
  bool is_approver = 3;
  bool is_proposer = 4;
}

message GetApproverWhitelistRequest {
}

message GetApproverWhitelistResponse {
  bool success = 1;
  string message = 2;
  repeated string addresses = 3;
}

message GetProposerWhitelistRequest {
}

message GetProposerWhitelistResponse {
  bool success = 1;
  string message = 2;
  repeated string addresses = 3;
}
